<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>MTG Proxy Wizard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #050505; --header-bg: rgba(19, 21, 26, 0.8);
            --card-bg: #13151a; --accent: #ff5d01;
            --accent-gradient: linear-gradient(45deg, #ff5d01, #da00ff);
            --text: #ffffff; --text-muted: #9ca3af; --border: rgba(255, 255, 255, 0.1);
            --input-bg: #0b0d11;
        }
        [data-theme="light"] {
            --bg: #f9fafb; --header-bg: rgba(255, 255, 255, 0.8);
            --card-bg: #ffffff; --text: #111827; --text-muted: #6b7280;
            --border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; min-height: 100vh; transition: 0.3s; }
        header { padding: 1.2rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--header-bg); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.4rem; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        
        .theme-toggle { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 0.5rem 1rem; border-radius: 2rem; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

        .controls-container { max-width: 1100px; margin: 1.5rem auto; padding: 0 1rem; display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.5rem; }
        .box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        
        textarea { width: 100%; height: 140px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 0.6rem; color: var(--text); padding: 0.8rem; font-family: monospace; resize: vertical; box-sizing: border-box; outline: none; font-size: 0.8rem; }
        input[type="text"] { width: 100%; padding: 0.8rem; background: var(--input-bg); border: 1px solid var(--border); border-radius: 0.6rem; color: var(--text); box-sizing: border-box; outline: none; }
        
        .btn { padding: 0.8rem; border-radius: 0.6rem; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 0.8rem; }
        .btn-primary { background: var(--text); color: var(--bg); }
        .btn-accent { background: var(--accent-gradient); color: white; }
        
        .card-grid { max-width: 1200px; margin: 0 auto; padding: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        .card-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 0.8rem; padding: 0.6rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .card-item img { width: 100%; border-radius: 0.5rem; margin-bottom: 0.6rem; background: #222; min-height: 230px; }
        
        .card-actions { display: flex; gap: 0.4rem; justify-content: center; }
        .btn-round { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; background: var(--input-bg); color: var(--text); border: 1px solid var(--border); cursor: pointer; }
        .btn-round:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-art { flex-grow: 1; height: 32px; border-radius: 16px; font-size: 0.65rem; font-weight: bold; background: var(--text); color: var(--bg); border: none; cursor: pointer; }

        #artModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); backdrop-filter: blur(8px); overflow-y: auto; }
        .modal-content { background: var(--card-bg); margin: 3% auto; padding: 2rem; width: 90%; max-width: 900px; border-radius: 1rem; border: 1px solid var(--border); }
        .art-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .art-option-container { position: relative; cursor: pointer; transition: 0.2s; border-radius: 0.5rem; border: 2px solid transparent; overflow: hidden; }
        .art-option-container:hover { border-color: var(--accent); transform: translateY(-3px); }
        .art-option-container img { width: 100%; display: block; }
        .apply-all-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: var(--accent); color: white; font-size: 0.55rem; font-weight: bold; padding: 4px; text-align: center; transform: translateY(100%); transition: 0.2s; }
        .art-option-container:hover .apply-all-overlay { transform: translateY(0); }

        #status-bar { position: fixed; bottom: 1rem; right: 1rem; background: var(--accent-gradient); color: white; padding: 0.8rem 1.5rem; border-radius: 2rem; display: none; z-index: 1100; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>MTG PROXY WIZARD üßô‚Äç‚ôÇÔ∏è</h1>
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üåô</span> <span id="theme-text">Dark Mode</span>
    </button>
</header>

<div class="controls-container">
    <div class="box">
        <label style="font-size: 0.7rem; color: var(--text-muted);">DECKLISTE ODER SCRYFALL-LINKS</label>
        <textarea id="listInput" placeholder="4 Sol Ring&#10;1 https://scryfall.com/card/mh2/261/urzas-saga"></textarea>
        <button class="btn btn-primary" onclick="loadCards()">Liste laden</button>
    </div>
    <div class="box">
        <input type="text" id="fileNameInput" placeholder="Dateiname (Optional)">
        <select id="pageSize" style="padding: 0.8rem; border-radius: 0.6rem; background: var(--input-bg); color: var(--text); border: 1px solid var(--border);">
            <option value="5x7">Foto Papier (5x7")</option>
            <option value="a4">Standard A4</option>
        </select>
        <button id="dlBtn" class="btn btn-accent" onclick="generatePDF()">PDF Generieren</button>
    </div>
</div>

<div class="card-grid" id="cardGrid"></div>

<div id="artModal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer;" onclick="closeModal()">‚úï</span>
        <h2 id="modalTitle" style="margin-top:0;">Variante w√§hlen</h2>
        <p style="font-size: 0.8rem; color: var(--text-muted);">Klick: Einzeln | <b>ALT + Klick</b>: Alle gleichen Karten</p>
        <div id="artSelectionGrid" class="art-selection-grid"></div>
    </div>
</div>

<div id="status-bar">Verarbeite...</div>

<script>
    let cardData = [];
    let currentEditIndex = null;
    let preferredArts = JSON.parse(localStorage.getItem('mtg_preferred_arts') || '{}');

    // On Load: Deckliste wiederherstellen
    window.onload = () => {
        const savedList = localStorage.getItem('mtg_last_decklist');
        if (savedList) {
            document.getElementById('listInput').value = savedList;
        }
    };

    function toggleTheme() {
        const h = document.documentElement;
        const icon = document.getElementById('theme-icon');
        const text = document.getElementById('theme-text');
        if (h.getAttribute('data-theme') === 'dark') {
            h.setAttribute('data-theme', 'light'); icon.innerText = '‚òÄÔ∏è'; text.innerText = 'Light Mode';
        } else {
            h.setAttribute('data-theme', 'dark'); icon.innerText = 'üåô'; text.innerText = 'Dark Mode';
        }
    }

    async function resolveInput(input) {
        input = input.trim();
        if (input.includes('scryfall.com/card/')) {
            try {
                const parts = input.split('/card/')[1].split('/');
                const res = await fetch(`https://api.scryfall.com/cards/${parts[0]}/${parts[1]}`);
                return await res.json();
            } catch (e) { return null; }
        }
        try {
            let url = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(input)}`;
            if (input.toLowerCase().includes('token')) {
                const clean = input.toLowerCase().replace('token', '').trim();
                url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(clean)}+is%3Atoken`;
            }
            const res = await fetch(url);
            const data = await res.json();
            return data.id ? data : (data.data ? data.data[0] : null);
        } catch (e) { return null; }
    }

    async function loadCards() {
        const input = document.getElementById('listInput').value;
        // Liste im localStorage speichern
        localStorage.setItem('mtg_last_decklist', input);
        
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '<p>Lade Karten...</p>';
        cardData = [];

        const lines = input.split('\n').filter(l => l.trim());
        for (let line of lines) {
            let count = 1, content = line.trim();
            const match = content.match(/^(\d+)\s+(.*)$/);
            if (match) { count = parseInt(match[1]); content = match[2]; }

            let data = null;
            if (preferredArts[content]) {
                const res = await fetch(`https://api.scryfall.com/cards/${preferredArts[content]}`);
                data = await res.json();
            } else {
                data = await resolveInput(content);
            }

            if (data && (data.image_uris || data.card_faces)) {
                const img = data.image_uris?.normal || data.card_faces[0].image_uris.normal;
                for (let i = 0; i < count; i++) {
                    cardData.push({ 
                        id: data.id, 
                        name: data.name, 
                        originalSearchName: content, 
                        image: img, 
                        isToken: data.layout === 'token' 
                    });
                }
            }
        }
        renderPreview();
    }

    function renderPreview() {
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = cardData.length ? '' : '<p>Keine Karten in der Vorschau.</p>';
        cardData.forEach((card, i) => {
            const div = document.createElement('div');
            div.className = 'card-item';
            div.innerHTML = `
                <img src="${card.image}" id="main-img-${i}">
                <div class="card-actions">
                    <button class="btn-round" onclick="removeCard(${i})">‚àí</button>
                    <button class="btn-art" onclick="openArtPicker(${i})">VARIANTE</button>
                    <button class="btn-round" onclick="duplicateCard(${i})">+</button>
                </div>
            `;
            grid.appendChild(div);
        });
    }

    function duplicateCard(i) {
        const newCard = JSON.parse(JSON.stringify(cardData[i]));
        cardData.splice(i + 1, 0, newCard);
        renderPreview();
    }

    function removeCard(i) {
        cardData.splice(i, 1);
        renderPreview();
    }

    async function openArtPicker(index) {
        currentEditIndex = index;
        const card = cardData[index];
        const modal = document.getElementById('artModal');
        const artGrid = document.getElementById('artSelectionGrid');
        document.getElementById('modalTitle').innerText = card.name;
        modal.style.display = "block";
        artGrid.innerHTML = "Lade Varianten...";

        try {
            const q = card.isToken ? `!"${card.name}" is:token` : `!"${card.name}" unique:prints`;
            const res = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            artGrid.innerHTML = "";
            data.data.forEach(print => {
                const imgUrl = print.image_uris?.normal || print.card_faces[0].image_uris.normal;
                const container = document.createElement('div');
                container.className = 'art-option-container';
                container.innerHTML = `<img src="${imgUrl}"><div class="apply-all-overlay">ALT+KLICK: Alle</div>`;
                container.onclick = (e) => {
                    if (e.altKey) applyToAll(card.name, imgUrl, print.id, card.originalSearchName);
                    else selectArt(imgUrl, print.id, card.originalSearchName);
                };
                artGrid.appendChild(container);
            });
        } catch (e) { artGrid.innerHTML = "Fehler beim Laden."; }
    }

    function selectArt(url, id, originalName) {
        cardData[currentEditIndex].image = url;
        cardData[currentEditIndex].id = id;
        preferredArts[originalName] = id;
        localStorage.setItem('mtg_preferred_arts', JSON.stringify(preferredArts));
        document.getElementById(`main-img-${currentEditIndex}`).src = url;
        closeModal();
    }

    function applyToAll(name, imageUrl, id, originalName) {
        cardData.forEach(card => {
            if (card.name === name) {
                card.image = imageUrl;
                card.id = id;
            }
        });
        preferredArts[originalName] = id;
        localStorage.setItem('mtg_preferred_arts', JSON.stringify(preferredArts));
        renderPreview();
        closeModal();
    }

    function closeModal() { document.getElementById('artModal').style.display = "none"; }

    async function generatePDF() {
        if (cardData.length === 0) return;
        const status = document.getElementById('status-bar');
        status.style.display = "block";
        
        const { jsPDF } = window.jspdf;
        const format = document.getElementById('pageSize').value;
        const is5x7 = format === '5x7';
        const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: is5x7 ? [5, 7] : 'a4' });
        const w = 2.5, h = 3.5, perPage = is5x7 ? 4 : 9, cols = is5x7 ? 2 : 3;

        for (let i = 0; i < cardData.length; i++) {
            status.innerText = `PDF wird erstellt: ${i+1}/${cardData.length}`;
            if (i > 0 && i % perPage === 0) doc.addPage();
            const pIdx = i % perPage;
            const x = (is5x7 ? 0 : 0.44) + (pIdx % cols) * w;
            const y = (is5x7 ? 0 : 0.44) + Math.floor(pIdx / cols) * h;
            const imgData = await getBase64(cardData[i].image);
            doc.addImage(imgData, 'JPEG', x, y, w, h, undefined, 'FAST');
        }

        // Timestamp Generierung (YYMMDD_HHMM)
        const now = new Date();
        const ts = now.toISOString().slice(2,10).replace(/-/g, '') + "_" + 
                   now.getHours().toString().padStart(2, '0') + 
                   now.getMinutes().toString().padStart(2, '0');
        
        const userTitle = document.getElementById('fileNameInput').value.trim() || 'Proxies';
        doc.save(`${ts}_${userTitle}.pdf`);
        status.style.display = "none";
    }

    function getBase64(url) {
        return new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = img.width; c.height = img.height;
                const ctx = c.getContext('2d');
                ctx.filter = 'brightness(1.05) saturate(1.02)';
                ctx.drawImage(img, 0, 0);
                resolve(c.toDataURL('image/jpeg', 0.8));
            };
            img.src = url + "?cache=" + Date.now();
        });
    }
</script>
</body>
</html>
